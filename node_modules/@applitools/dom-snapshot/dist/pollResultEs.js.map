{"version":3,"file":"pollResultEs.js","sources":["../../dom-shared/dist/chunkify.js","../../dom-shared/dist/poll.js","../../dom-shared/dist/pollify.js","../../dom-shared/dist/browser/absolutizeUrl.js","../../dom-shared/dist/browser/isInlineFrame.js","../../dom-shared/dist/browser/isAccessibleFrame.js","../../dom-shared/dist/index.js","../src/browser/pollResult.ts","../src/browser/constants.ts"],"sourcesContent":["\"use strict\";\nfunction charCodeAt(string, index = 0) {\n    const code = string.charCodeAt(index);\n    // if the code of high word (16 bits) in this diapason the character encoded by two words\n    if (code >= 0xd800 && code < 0xdc00) {\n        const high = code;\n        const low = string.charCodeAt(index + 1);\n        // convert 2 utf16le words into integer code\n        return (high - 0xd800) * 0x400 + (low - 0xdc00) + 0x10000;\n    }\n    // diapason is reserved for surrogates, we can skip it\n    if (0xdc00 <= code && code <= 0xdfff)\n        return -1;\n    return code;\n}\nfunction chunkify(string, chunkByteLength) {\n    const chunks = [];\n    let currChunkByteLength = 0;\n    for (let index = 0; index < string.length; ++index) {\n        const code = charCodeAt(string, index);\n        let charByteLength = 0;\n        if (code > 0) {\n            if (code < 128)\n                charByteLength = 1;\n            else if (code < 2048)\n                charByteLength = 2;\n            else if (code < 65536)\n                charByteLength = 3;\n            else if (code < 2097152)\n                charByteLength = 4;\n            else if (code < 67108864)\n                charByteLength = 5;\n            else\n                charByteLength = 6;\n        }\n        if (currChunkByteLength + charByteLength > chunkByteLength) {\n            chunks.push(index);\n            currChunkByteLength = charByteLength;\n        }\n        else {\n            currChunkByteLength += charByteLength;\n        }\n    }\n    return chunks;\n}\nmodule.exports = chunkify;\n","\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nconst chunkify_1 = __importDefault(require(\"./chunkify\"));\nconst STATUSES = {\n    WIP: 'WIP',\n    SUCCESS: 'SUCCESS',\n    SUCCESS_CHUNKED: 'SUCCESS_CHUNKED',\n    ERROR: 'ERROR',\n};\nconst _DEFAULT_CHUNK_BYTE_LENGTH = 268435456; // 256MB\nfunction createPollResponse(state, { chunkByteLength = 0 } = {}) {\n    if (!state) {\n        return {\n            status: STATUSES.ERROR,\n            error: 'unexpected poll request received - cannot find state of current operation',\n        };\n    }\n    else if (state.value) {\n        if (chunkByteLength) {\n            if (!state.chunks) {\n                try {\n                    const stringified = JSON.stringify(state.value);\n                    state.chunks = (0, chunkify_1.default)(stringified, chunkByteLength);\n                    if (state.chunks.length > 0) {\n                        state.from = 0;\n                        state.value = stringified;\n                    }\n                }\n                catch (e) {\n                    return { status: STATUSES.ERROR, error: e.message };\n                }\n            }\n            if (state.from >= 0) {\n                return {\n                    status: STATUSES.SUCCESS_CHUNKED,\n                    value: state.value.substring(state.from, (state.from = state.chunks.shift())),\n                    done: !state.from,\n                };\n            }\n        }\n        return { status: STATUSES.SUCCESS, value: state.value };\n    }\n    else if (state.error) {\n        return { status: STATUSES.ERROR, error: state.error };\n    }\n    else {\n        return { status: STATUSES.WIP };\n    }\n}\nfunction poll(context, key, options = {}) {\n    context = context || {};\n    const result = createPollResponse(context[key], options);\n    if (result.status === STATUSES.SUCCESS ||\n        result.status === STATUSES.ERROR ||\n        (result.status === STATUSES.SUCCESS_CHUNKED && result.done)) {\n        delete context[key];\n    }\n    return result;\n}\nmodule.exports = poll;\n","\"use strict\";\nconst poll = require(\"./poll\");\nfunction pollify(script, context, key) {\n    return (options) => function (...args) {\n        if (!context[key]) {\n            context[key] = {};\n            Promise.resolve()\n                .then(() => script(...args))\n                .then(value => (context[key].value = value))\n                .catch(err => (context[key].error = err.message + '\\nStack:' + err.stack));\n        }\n        return poll(context, key, options);\n    };\n}\nmodule.exports = pollify;\n","\"use strict\";\nfunction isAbsoluteUrl(url) {\n    try {\n        new URL(url);\n        return true;\n    }\n    catch (err) {\n        return false;\n    }\n}\nfunction absolutizeUrl(url, baseUrl) {\n    if (isAbsoluteUrl(url))\n        return url;\n    let isEncoded = true;\n    try {\n        isEncoded = url !== decodeURI(url);\n    }\n    catch (err) {\n        isEncoded = true;\n    }\n    try {\n        const absoluteUrl = new URL(url, baseUrl).href;\n        return !isEncoded ? decodeURI(absoluteUrl) : absoluteUrl;\n    }\n    catch (err) {\n        return !isEncoded ? decodeURI(url) : url;\n    }\n}\nmodule.exports = absolutizeUrl;\n","\"use strict\";\nfunction isInlineFrame(frame) {\n    return (frame.contentDocument &&\n        frame.contentDocument.location &&\n        !/^https?:$/.test(frame.contentDocument.location.protocol));\n}\nmodule.exports = isInlineFrame;\n","\"use strict\";\nfunction isAccessibleFrame(frame) {\n    try {\n        const doc = frame.contentDocument;\n        return Boolean(doc && doc.defaultView && doc.defaultView.frameElement);\n    }\n    catch (err) {\n        return false;\n    }\n}\nmodule.exports = isAccessibleFrame;\n","\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.isAccessibleFrame = exports.isInlineFrame = exports.absolutizeUrl = exports.poll = exports.pollify = exports.chunkify = void 0;\nconst chunkify_1 = __importDefault(require(\"./chunkify\"));\nexports.chunkify = chunkify_1.default;\nconst pollify_1 = __importDefault(require(\"./pollify\"));\nexports.pollify = pollify_1.default;\nconst poll_1 = __importDefault(require(\"./poll\"));\nexports.poll = poll_1.default;\nconst absolutizeUrl_1 = __importDefault(require(\"./browser/absolutizeUrl\"));\nexports.absolutizeUrl = absolutizeUrl_1.default;\nconst isInlineFrame_1 = __importDefault(require(\"./browser/isInlineFrame\"));\nexports.isInlineFrame = isInlineFrame_1.default;\nconst isAccessibleFrame_1 = __importDefault(require(\"./browser/isAccessibleFrame\"));\nexports.isAccessibleFrame = isAccessibleFrame_1.default;\n",null,null],"names":["charCodeAt","string","index","code","chunkify_1","chunkByteLength","chunks","currChunkByteLength","length","charByteLength","push","mod","__esModule","default","__importDefault","require$$0","STATUSES","WIP","SUCCESS","SUCCESS_CHUNKED","ERROR","poll_1","context","key","options","result","state","value","stringified","JSON","stringify","from","e","status","error","message","substring","shift","done","createPollResponse","poll","pollify_1","script","args","Promise","resolve","then","catch","err","stack","absolutizeUrl_1","url","baseUrl","URL","isAbsoluteUrl","isEncoded","decodeURI","absoluteUrl","href","isInlineFrame_1","frame","contentDocument","location","test","protocol","isAccessibleFrame_1","doc","Boolean","defaultView","frameElement","Object","defineProperty","dist","isAccessibleFrame","isInlineFrame","absolutizeUrl","pollify","chunkify","require$$1","require$$2","require$$3","require$$4","require$$5","window"],"mappings":"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"}